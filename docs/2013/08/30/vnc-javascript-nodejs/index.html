    <!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		
		<meta name="generator" content="Hugo 0.55.5" />
		<title>VNC client on 200 lines of JavaScript &middot; Minko Gechev&#39;s blog</title>
		<link rel="shortcut icon" href="https://blog.mgechev.com/images/favicon.ico">
		<link rel="stylesheet" href="https://blog.mgechev.com/css/highlight.css">
		<link rel="stylesheet" href="https://blog.mgechev.com/css/style.css">
		

		
		<link rel="stylesheet" href="https://blog.mgechev.com/css/font-awesome.min.css">
		

		
		<link href="https://blog.mgechev.com/feed.xml" rel="alternate" type="application/rss+xml" title="Minko Gechev&#39;s blog">
		
		
		<link rel="amphtml" href="https://blog.mgechev.com/amp/2013/08/30/vnc-javascript-nodejs/">
		

		<meta property="og:title" content="VNC client on 200 lines of JavaScript" />
		<meta property="og:description" content="In this quick blog post I’ll show you how to create a simple VNC client in about 200 lines of JavaScript. For our goal we’re going to use only HTML5 and JavaScript (client and server side). The end result will be something like this:

So, let’s begin!
Our application will have very simple architecture – a proxy server written in Node.js and a client in HTML5 and JavaScript. The Node." />
		<meta property="og:type" content="article" />
		<meta property="og:url" content="https://blog.mgechev.com/2013/08/30/vnc-javascript-nodejs/" />
		
		<meta property="og:image" content="https://blog.mgechev.com/images/myself.jpg"/>
		<meta property="og:image:secure_url" content="https://blog.mgechev.com/images/myself.jpg"/>
		
	</head>

    <body>
       <nav class="main-nav">
  
  <div class="link-wrapper">
	
	
		<a href='https://blog.mgechev.com/'> <span class="arrow">←</span>Home</a>
	
	<a href='https://blog.mgechev.com/post'>Posts</a>
	<a href='https://blog.mgechev.com/about'>About</a>
	<a href='https://blog.mgechev.com/talks'>Speaking</a>
  </div>

	

	
  
	
</nav>
<a href="https://github.com/mgechev" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="z-index: 100000; fill:#70B7FD; color:#fff; position: fixed; top: 20px; border: 0; left: 20px; transform: scale(-1.5, 1.5);" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


        <section id="wrapper">
            <article class="post">
                <header>
                    <h1>
                        VNC client on 200 lines of JavaScript
                    </h1>
                    <h2 class="headline">
                    <a href="https://github.com/mgechev/blog.mgechev.com/tree/master/content/post/2013-08-30-vnc-javascript-nodejs.md">
                        <i class="fa fa-pencil-square-o"></i> Edit
                    </a>
                    · Aug 30, 2013
                    · 8 minutes read
                    · <a href="https://twitter.com/mgechev?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="true">Follow @mgechev</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                      <span class="tags">
                      
                      
                          
                              <a href="https://blog.mgechev.com/tags/computer-science">Computer science</a>
                          
                              <a href="https://blog.mgechev.com/tags/development">Development</a>
                          
                              <a href="https://blog.mgechev.com/tags/html5">HTML5</a>
                          
                              <a href="https://blog.mgechev.com/tags/http">HTTP</a>
                          
                              <a href="https://blog.mgechev.com/tags/javascript">JavaScript</a>
                          
                              <a href="https://blog.mgechev.com/tags/node.js">Node.js</a>
                          
                              <a href="https://blog.mgechev.com/tags/opensource">OpenSource</a>
                          
                              <a href="https://blog.mgechev.com/tags/vnc">vnc</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    <p>In this quick blog post I’ll show you how to create a simple VNC client in about 200 lines of JavaScript.
For our goal we’re going to use only HTML5 and JavaScript (client and server side).
The end result will be something like this:</p>

<p><a href="/images/legacy/uploads2013/08/js-vnc.png"><img src="/images/legacy/uploads/2013/08/js-vnc-1024x946.png" alt="js-vnc" width="600" height="554" class="alignnone size-large wp-image-500" /></a></p>

<p>So, let’s begin!</p>

<p>Our application will have very simple architecture – a proxy server written in Node.js and a client in HTML5 and JavaScript. The Node.js server will stay between the browser and the VNC server. We need it because the client-side JavaScript does not supports TCP sockets so we can’t connect directly to the VNC server. The HTML5 client will have a canvas on which we will draw the frames we receive from the server.
For VNC server you can use the free version of <a href="http://www.realvnc.com/">RealVNC</a>.</p>

<p>First lets start with the server. Make sure you have node.js installed. We will use four node modules: <a href="https://github.com/sidorares/node-rfb2">rfb2</a>, <a href="https://npmjs.org/package/connect">connect</a>, <a href="http://socket.io/">socket.io</a> and <a href="https://github.com/pkrumins/node-png">node-png</a>.</p>

<p>Enter the following commands in your terminal:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~
mkdir js-vnc
<span class="nb">cd</span> js-vnc
npm init</code></pre></div>

<p>Now you should have folder called “js-vnc” with file named “package.json” in it.
Use the following line of code to install almost all the dependencies:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npm install rfb2 connect socket.io --save</code></pre></div>

<p>Unfortunately node-png is not in the npm registry and we have to build it from source.
Use:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo npm install -g node-gyp
<span class="nb">cd</span> node_modules
git clone git@github.com:pkrumins/node-png.git
<span class="nb">cd</span> node-png
node-gyp configure build</code></pre></div>

<p>and that was all&hellip;Now we can start creating our server.
Let’s include all the required modules and initialize an array which will contains all the connected clients. Create a file called “server.js” in your project base directory and add the following content in it:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">rfb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;rfb2&#39;</span><span class="p">),</span>
    <span class="nx">socketio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8091</span><span class="p">,</span> <span class="p">{</span> <span class="nx">log</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}),</span>
    <span class="nx">Png</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./node_modules/node-png/build/Release/png&#39;</span><span class="p">).</span><span class="nx">Png</span><span class="p">,</span>
    <span class="nx">connect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">),</span>
    <span class="nx">clients</span> <span class="o">=</span> <span class="p">[];</span>
</code></pre></div>

<p>and now let’s create a static directory for our static resources:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">mkdir static</code></pre></div>

<p>now we can set the static directory of the connect server:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">//creating new HTTP server. It will serve static files from the directory <span class="s2">&#34;./static&#34;</span> and will listen on <span class="m">8090</span> port
connect.createServer<span class="o">(</span>connect.static<span class="o">(</span><span class="s1">&#39;./static&#39;</span><span class="o">))</span>.listen<span class="o">(</span><span class="m">8090</span><span class="o">)</span><span class="p">;</span></code></pre></div>

<p>Now you can execute the following lines of code:</p>

<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">&#34;Hello, world!&#34;</span> &gt; ./static/index.html
node server.js</code></pre></div>

<p>Now open: <a href="http://localhost:8091/index.html">http://localhost:8091/index.html</a>. If everything went well you should see the text: “Hello, world!”.</p>

<p>So far, so good! Now lets create a socket.io server.
We want the client to connect to our proxy server and exchange data through socket.io with it. When the client is connected (i.e. the connection is established) it sends “init” message which contains the data required for the proxy server to connect to the VNC server – host, port and password.
So let’s handle these events:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">socketio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">createRfbConnection</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evnt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">pointerEvent</span><span class="p">(</span><span class="nx">evnt</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">evnt</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">evnt</span><span class="p">.</span><span class="nx">button</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evnt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">keyEvent</span><span class="p">(</span><span class="nx">evnt</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="nx">evnt</span><span class="p">.</span><span class="nx">isDown</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">disconnectClient</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<p>We already listen for incoming connections with socket.io on port 8091 so now we just subscribe to the “connection” event. When the client connects to our socket.io server we subscribe the server to the “init” event. It’s the message I told about earlier. Its parameters will contains data required for the proxy server to connect to the VNC server. In the callback associated with the “init” event we first create new RFB (remote framebuffer) connection. This method will return a RFB handler, we can use it to exchange data with the VNC server. After initialising the RFB connection we subscribe to three more events: “mouse”, “keyboard” and “disconnect”. The mouse event has parameter containing the position of the cursor and button state (1 for mouse down 0 for mouse up). For this demo we will support only the first mouse button. The keyboard event accepts as parameters the key code of the button which have triggered the event and flag which indicates whether the button is down or up. When the disconnect event happens we disconnect from the VNC server and release all the data for the current connection.</p>

<p>Here is posted the function createRfbConnection:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">createRfbConnection</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">rfb</span><span class="p">.</span><span class="nx">createConnection</span><span class="p">({</span>
    <span class="nx">host</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
    <span class="nx">port</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">password</span>
  <span class="p">});</span>
  <span class="nx">addEventHandlers</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">socket</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>In the method “addEventHandlers” we add event handlers to the RFB handler we received from the “createConnection” method:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">addEventHandlers</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">height</span>
    <span class="p">});</span>
    <span class="nx">clients</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">socket</span><span class="o">:</span> <span class="nx">socket</span><span class="p">,</span>
      <span class="nx">rfb</span><span class="o">:</span> <span class="nx">r</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handleFrame</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">rect</span><span class="p">,</span> <span class="nx">r</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>When the RFB connection is established we send “init” event to the client (our browser) with the size of the screen. For simplicity we won’t scale the screen in the browser.
After sending the “init” event to the browser we add the client to our connected clients and subscribe to the event “rect”. The “rect” event will trigger when there is a screen update. For extra simplicity we will use raw encoding.</p>

<p>The last method from our Node.js proxy we will look at is the “handleFrame” method.</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">handleFrame</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">rect</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rgb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">),</span>
    <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rgb</span><span class="p">[</span><span class="nx">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
    <span class="nx">rgb</span><span class="p">[</span><span class="nx">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="nx">rgb</span><span class="p">[</span><span class="nx">offset</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Png</span><span class="p">(</span><span class="nx">rgb</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="s1">&#39;rgb&#39;</span><span class="p">);</span>
  <span class="nx">image</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">encodeSync</span><span class="p">();</span>
  <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">x</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
    <span class="nx">y</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
    <span class="nx">width</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
    <span class="nx">height</span><span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span>
    <span class="nx">image</span><span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">)</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>We create new binary buffer with size &ldquo;rect.width * rect.height * 3&rdquo; and process the received pixmap. After that we create new PNG image from it by specifying its width, height and format (rgb). We encode the image and emit the event &ldquo;frame&rdquo; with parameters the coordinates of the image, its size and the actual image in base64 format.</p>

<p>And we&rsquo;re done with our server! There&rsquo;s one detail which I missed with purpose. In this version we don&rsquo;t use all the advantages of the RFB protocol. It has incremental frame transmitting which I&rsquo;ve omitted. RFB implementation with excluded incremental transmission can be downloaded from <a href="https://github.com/mgechev/node-rfb2">here</a>.</p>

<p>And now our simple client!</p>

<p>Edit the content of the file ./static/index.html with the following content:</p>

<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;./css/bootstrap.min.css&#34;</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;./css/styles.css&#34;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-wrapper&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;form-wrapper&#34;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">form</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-horizontal&#34;</span> <span class="na">onsubmit</span><span class="o">=</span><span class="s">&#34;return false&#34;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-group&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-label&#34;</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;host&#34;</span><span class="p">&gt;</span>Host:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;controls&#34;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;host&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;host&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;192.168.100.6&#34;</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-group&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-label&#34;</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;port&#34;</span><span class="p">&gt;</span>Port:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;controls&#34;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;port&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;port&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;5900&#34;</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-group&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-label&#34;</span> <span class="na">for</span><span class="o">=</span><span class="s">&#34;port&#34;</span><span class="p">&gt;</span>Port:<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;controls&#34;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;paralaks&#34;</span> <span class="p">/&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;control-group&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;controls&#34;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;btn&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;loginBtn&#34;</span><span class="p">&gt;</span>Log in<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;screen&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;http://localhost:8091/socket.io/socket.io.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;./js/Client.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span></code></pre></div>

<p>We&rsquo;ve added simple bootstrap form and a canvas. Now create sub-directory of our project base directory: &ldquo;./static/js&rdquo; and create the file &ldquo;Client.js&rdquo; in it.</p>

<p>We will wrap the whole code in an IIFE to omit any globals. Let&rsquo;s create a simple object which will hold our settings:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">URL</span><span class="o">:</span> <span class="s1">&#39;http://localhost:8091&#39;</span>
  <span class="p">};</span>
  <span class="c1">//..more code here
</span><span class="c1"></span><span class="p">}());</span>
</code></pre></div>

<p>Now lets add some code for initialisation after the &ldquo;Config&rdquo; declaration:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;loginBtn&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">screen</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Screen</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;screen&#39;</span><span class="p">)),</span>
      <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Client</span><span class="p">(</span><span class="nx">screen</span><span class="p">);</span>

    <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">({</span>
      <span class="nx">host</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
      <span class="nx">password</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
      <span class="nx">callback</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;form-wrapper&#39;</span><span class="p">).</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;form-wrapper-hidden&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div>

<p>We simply add event handler on click of the button with id &ldquo;loginBtn&rdquo;. In the callback we initialise new &ldquo;Screen&rdquo; object with our canvas as argument of the constructor function and create new &ldquo;Client&rdquo; with the Screen object as parameter. We call the connect method of the client with the specified parameters - host, port, password and a callback which will be invoked when the client is being connected.</p>

<p>This is the definition of the connect method:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">Config</span><span class="p">.</span><span class="nx">URL</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">host</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
      <span class="nx">port</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_addHandlers</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_initEventListeners</span><span class="p">();</span>
  <span class="p">};</span>
</code></pre></div>

<p>It creates new socket.io connection with the server&rsquo;s socket.io server host name and port and emits the &ldquo;init&rdquo; event we already talked about (contains data required for connection to the VNC server). After that we add handlers which will listen for events coming from the server - the &ldquo;init&rdquo; and &ldquo;rect&rdquo; event. Since the &ldquo;rect&rdquo; event is a bit more interesting we will look in its handling:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">this</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">that</span><span class="p">.</span><span class="nx">_screen</span><span class="p">.</span><span class="nx">drawRect</span><span class="p">(</span><span class="nx">frame</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div>

<p>As you see we simply delegate the drawing to the screen and pass it the frame as argument.
And here is the actual drawing on the canvas:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Screen</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawRect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">(),</span>
      <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;data:image/png;base64,&#39;</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">image</span><span class="p">;</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">_context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">};</span>
</code></pre></div>

<p>We create new image with the frame&rsquo;s width and height as dimensions and we set image&rsquo;s src to be equal to the frame&rsquo;s base64 image. After that, when the image is loaded we draw it onto the canvas.</p>

<p>The last interesting moment is the handling of the mouse and keyboard events.
Of course we delegate it to the screen object:</p>

<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_initEventListeners</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_screen</span><span class="p">.</span><span class="nx">addMouseHandler</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">,</span>
        <span class="nx">button</span><span class="o">:</span> <span class="nx">button</span>
      <span class="p">});</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_screen</span><span class="p">.</span><span class="nx">addKeyboardHandlers</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">isDown</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;keyboard&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">keyCode</span><span class="o">:</span> <span class="nx">code</span><span class="p">,</span>
        <span class="nx">isDown</span><span class="o">:</span> <span class="nx">isDown</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">};</span>
</code></pre></div>

<p>As you see we add the mouse and keyboard event handlers and in the event callbacks we simply emit new socket.io events, respectively: &ldquo;mouse&rdquo; and &ldquo;keyboard&rdquo;, with their arguments. For simplicity our canvas is absolutely positioned and has coordinates (0, 0).</p>

<p>And&hellip;well&hellip;thats all! We have ready to go VNC client in just few lines of JavaScript!</p>

<p><span style="font-size: 1.2em;">The <strong><a href="https://github.com/mgechev/js-vnc-demo-project">source code</a></strong> from this article can be found in my <a href="https://github.com/mgechev/js-vnc-demo-project">GitHub account</a></span>.</p>

<p>Quick video demo</p>

                </section>
            </article>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'mgechev';

     
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            

            

            <footer id="footer">
    <div class="by-author">with <i class="fa fa-heart" aria-hidden="true"></i> by Minko Gechev</div>
    <p class="small">
         © Copyright 2021  
    </p>
</footer>
        </section>

        <script src="https://blog.mgechev.com/js/main.js"></script>




  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-18060688-3', 'auto');
	
	ga('send', 'pageview');
}
</script>



<script async src="//twemoji.maxcdn.com/2/twemoji.min.js?2.3.0"></script>
<script>
  window.addEventListener('load', function () {
    twemoji.parse(document.body, { size: 72 });
  });
</script>



    </body>
</html>
